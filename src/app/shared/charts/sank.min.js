'use strict';var sankConst={nodeWidth:24,nodePadding:8,titleX:-6,titleDY:'.35em',colorDomain:['1MDB','Petrosaudi','Good Star','Totality LTD','Jasmine LOO Ai Swan'],colors:['#368FCE','#8C3F8E','#F48D27','#69CA6B','#95AF0D']};function sankey_chart(c){var f;c.container&&$(c.container).empty(),c&&(c.container=c.container?c.container:'body',c.data=c.data?c.data:[],c.header=c.header?c.header:'SANKEY CHART',c.randomIdString=Math.floor(1e10*Math.random()),c.height=c.height?c.height:600,c.margin=c.margin?{top:c.margin.top?c.margin.top:20,right:c.margin.right?c.margin.right:20,bottom:c.margin.bottom?c.margin.bottom:30,left:c.margin.left?c.margin.left:40}:{top:20,right:20,bottom:50,left:50},c.headerOptions=!1!=c.headerOptions||c.headerOptions,c.isHeaer=!1!=c.isHeaer||c.isHeaer);var g=jQuery.extend(!0,{},c),j=[];$.each(c.data.nodes,function(M,N){j.push(N.name)});var k=c.container,l=c.randomIdString,m=c.header;d3.sankey=function(){function M(){aa.forEach(function(ca){ca.sourceLinks=[],ca.targetLinks=[]}),ba.forEach(function(ca){var da=ca.source,ea=ca.target;'number'==typeof da&&(da=ca.source=aa[ca.source]),'number'==typeof ea&&(ea=ca.target=aa[ca.target]),da.sourceLinks.push(ca),ea.targetLinks.push(ca)})}function N(){aa.forEach(function(ca){ca.value=Math.max(d3.sum(ca.sourceLinks,V),d3.sum(ca.targetLinks,V))})}function O(){for(var da,ca=aa,ea=0;ca.length;)da=[],ca.forEach(function(fa){fa.x=ea,fa.dx=X,fa.sourceLinks.forEach(function(ga){da.push(ga.target)})}),ca=da,++ea;Q(ea),R((C-X)/(ea-1))}function Q(ca){aa.forEach(function(da){da.sourceLinks.length||(da.x=ca-1)})}function R(ca){aa.forEach(function(da){da.x*=ca})}function S(ca){function ea(ka){function la(ma){return U(ma.source)*ma.value}ia.forEach(function(ma){ma.forEach(function(oa){if(oa.targetLinks.length){var pa=d3.sum(oa.targetLinks,la)/d3.sum(oa.targetLinks,V);oa.y+=(pa-U(oa))*ka}})})}function fa(ka){function la(ma){return U(ma.target)*ma.value}ia.slice().reverse().forEach(function(ma){ma.forEach(function(na){if(na.sourceLinks.length){var oa=d3.sum(na.sourceLinks,la)/d3.sum(na.sourceLinks,V);na.y+=(oa-U(na))*ka}})})}function ga(){ia.forEach(function(ka){var la,ma,pa,na=0,oa=ka.length;for(ka.sort(ha),pa=0;pa<oa;++pa)la=ka[pa],ma=na-la.y,0<ma&&(la.y+=ma),na=la.y+la.dy+Y;if(ma=na-Y-Z[1],0<ma)for(na=la.y-=ma,pa=oa-2;0<=pa;--pa)la=ka[pa],ma=la.y+la.dy+Y-na,0<ma&&(la.y-=ma),na=la.y})}function ha(ka,la){return ka.y-la.y}var ia=d3.nest().key(function(ka){return ka.x}).sortKeys(d3.ascending).entries(aa).map(function(ka){return ka.values});(function(){var ka=d3.min(ia,function(la){return(Z[1]-(la.length-1)*Y)/d3.sum(la,V)});ia.forEach(function(la){la.forEach(function(ma,na){ma.y=na,ma.dy=ma.value*ka})}),ba.forEach(function(la){la.dy=la.value*ka})})(),ga();for(var ja=1;0<ca;--ca)fa(ja*=.99),ga(),ea(ja),ga()}function T(){function ca(ea,fa){return ea.source.y-fa.source.y}function da(ea,fa){return ea.target.y-fa.target.y}aa.forEach(function(ea){ea.sourceLinks.sort(da),ea.targetLinks.sort(ca)}),aa.forEach(function(ea){var fa=0,ga=0;ea.sourceLinks.forEach(function(ha){ha.sy=fa,fa+=ha.dy}),ea.targetLinks.forEach(function(ha){ha.ty=ga,ga+=ha.dy})})}function U(ca){return ca.y+ca.dy/2}function V(ca){return ca.value}var W={},X=sankConst.nodeWidth,Y=sankConst.nodePadding,Z=[1,1],aa=[],ba=[];return W.nodeWidth=function(ca){return arguments.length?(X=+ca,W):X},W.nodePadding=function(ca){return arguments.length?(Y=+ca,W):Y},W.nodes=function(ca){return arguments.length?(aa=ca,W):aa},W.links=function(ca){return arguments.length?(ba=ca,W):ba},W.size=function(ca){return arguments.length?(Z=ca,W):Z},W.layout=function(ca){return M(),N(),O(),S(ca),T(),W},W.relayout=function(){return T(),W},W.link=function(){function ca(ea){var fa=ea.source.x+ea.source.dx,ga=ea.target.x,ha=d3.interpolateNumber(fa,ga),ia=ha(da),ja=ha(1-da),ka=ea.source.y+ea.sy+ea.dy/2,la=ea.target.y+ea.ty+ea.dy/2;return'M-10,-10M'+fa+','+ka+'C'+ia+','+ka+' '+ja+','+la+' '+ga+','+la}var da=.5;return ca.curvature=function(ea){return arguments.length?(da=+ea,ca):da},ca},W};var l=Math.floor(1e10*Math.random()),o=c.height+50,q=$(window).width()-200;$(c.container).html('<div class="chartContainer"  align="center" style="width: 100%; margin: auto; margin-top: 0px; font-size: 12px;font-style: inherit;"> <div class="graphBox" style="height:'+o+'px;max-height: '+o+'px;min-height: '+o+'px;margin: auto; background-color: #374c59; width: 100%;left: 0px;top: 0px;position: relative;"> <div class="headerDiv" style="font-weight:bold;background-color: #425661;text-align: left;color: #239185; border-bottom: 1px solid rgba(192, 192, 192, 0.47);width: 100%; line-height: 2.5;font-size: 16px ;padding-left: 5px;">'+m+'</div><div id="sankey_chart_div'+l+'" class="chartContentDiv" style="width: 100%;"></div> </div></div>'),$(c.container).append(' <div id="modal_'+l+'"class="modal fade " tabindex="-1" role="dialog"> <div class="modal-dialog modal-lg" style="width:'+q+'px"> <form ><div class="modal-content"><div class="modal-body"  style="padding:0;background-color:#334d59" id="modal_chart_container'+l+'"></div></div></form></div></div>');var t='#sankey_chart_div'+l;if(!c.headerOptions){$(t).siblings('.headerDiv').append('<button type="button" class="cancel" style="float: right;padding:0 8px;border:0;opacity: 1;background-color: transparent;float:right" data-dismiss="modal" aria-label="Close"> <span class="fa fa-remove"></span></button>')}if(0==$(t).siblings('.headerDiv').find('.bstheme_menu_button').length)var w='<div style="float: right; padding: 0 10px; cursor: pointer;" class="bstheme_menu_button bstheme_menu_button_'+l+'" data-toggle="collapse" data-target="#opt_'+l+'"><i class="fa fa-ellipsis-v" aria-hidden="true"></i><div class="bstheme_options" style="position:absolute;right:10px;z-index:2000"> <div style="display:none; min-width: 120px; margin-top: 2px; background: rgb(27, 39, 53) none repeat scroll 0% 0%; border: 1px solid rgb(51, 51, 51); border-radius: 4px;" id="opt_'+l+'" class="collapse"><span style="display: inline-block;float: left;text-align: center;width: 33.33%; border-right: 1px solid #000;" class="header_fullscreen_chart'+l+'"><i class="fa fa-expand" aria-hidden="true"></i></span><span style="display: inline-block;float: left;text-align: center;width: 33.33%; border-right: 1px solid #000;" class="header_refresh_'+l+'"><i class="fa fa-refresh" aria-hidden="true"></i></span> <span style="display: inline-block;float: left;text-align: center;width: 33.33%;" class="header_table_'+l+'"> <i class="fa fa-table" aria-hidden="true"></i></span> <span style="display: none;float: left;text-align: center;width: 33.33%;" class="header_chart_'+l+'" ><i class="fa fa-bar-chart" aria-hidden="true"></i></span></div></div> </div>';$(t).siblings('.headerDiv').append(w),c.headerOptions?$(t).siblings('.headerDiv').find('.bstheme_options').css('right','0'):($(t).siblings('.headerDiv').find('.bstheme_options').css('right','28px'),$('.header_fullscreen_chart'+l).css('display','none')),$('.graphBox').mCustomScrollbar({axis:'y'}),$('.sank_tooltip').remove();$('body').append('<div class="sank_tooltip text-uppercase" style="visibility:visible;display:none"><span class="sank_tooltip_next"><span class="tool_tip_x_val"></span><table><tbody><tr><td> </td><td><b>216.4 mm</b></td></tr><tr><td class="city-color-one">New York: </td><td><b>91.2 mm</b></td></tr><tr><td class="city-color-two">London: </td><td><b>52.4 mm</b></td></tr><tr><td class="city-color-three">Berlin: </td><td><b>47.6 mm</b></td></tr></tbody></table></span></div>');c.isHeaer||$(t).siblings('.headerDiv').remove();c.width=c.width?c.width:$(t).width()-20;var B=c.margin,C=c.width-B.left-B.right,D=c.height-B.top-B.bottom,G=d3.format(',.0f'),F=d3.scaleOrdinal().domain(j).range(sankConst.colors);d3.select(t).style('visibility','visible');var I=d3.select(t).append('svg').attr('width',C+B.left+B.right).attr('height',D+B.top+B.bottom).append('g').attr('transform','translate('+B.left+','+B.top+')'),J=d3.sankey().nodeWidth(12).nodePadding(10).size([C,D]),K=J.link(),L=I.append('defs');(function(M){J.nodes(M.nodes).links(M.links).layout(14);var O=I.append('g').selectAll('.link').data(M.links).enter().append('path').attr('class','link').attr('d',K).style('stroke-width',function(Q){return Math.max(1,Q.dy)}).style('fill','none').style('stroke-opacity',1.4).sort(function(Q,R){return R.dy-Q.dy}).on('mouseover',function(Q){return Q.txt?$('.sank_tooltip').html(Q.txt):$('.sank_tooltip').html('<div>'+Q.label+'</div><span> Type: '+Q.source.name+'</span><br><span> Value: '+G(Q.value)+'</span>'),$('.sank_tooltip').css('display','block')}).on('mousemove',function(){var Q=$(t),R=Q.offset(),S=window.innerWidth,T=$('.sank_tooltip').width()+50,U=d3.event.x;if(console.log(U,T,R.left<d3.event.pageX,U>T,R.left<d3.event.pageX&&U<T),R.left<d3.event.pageX&&U>T){console.log('moveleft');var V=document.getElementsByClassName('sank_tooltip');V[0].classList.add('tooltip-right'),$('.sank_tooltip').css('left',d3.event.pageX-15-$('.sank_tooltip').width()+'px')}else{console.log('moveright');var V=document.getElementsByClassName('sank_tooltip');V[0].classList.remove('tooltip-right'),$('.sank_tooltip').css('left',d3.event.pageX+10+'px')}return $('.sank_tooltip').css('top',d3.event.pageY+'px')}).on('mouseout',function(){return $('.sank_tooltip').css('display','none')}),P=I.append('g').selectAll('.node').data(M.nodes).enter().append('g').attr('class','node').attr('transform',function(Q){return'translate('+Q.x+','+Q.y+')'}).call(d3.drag().subject(function(Q){return Q}).on('start',function(){this.parentNode.appendChild(this)}).on('drag',function(Q){d3.select(this).attr('transform','translate('+(Q.x=Math.max(0,Math.min(C-Q.dx,d3.event.x)))+','+(Q.y=Math.max(0,Math.min(D-Q.dy,d3.event.y)))+')'),J.relayout(),O.attr('d',K)}));P.append('rect').attr('height',function(Q){return 0>Q.dy?(f||(f=Q.dy),f>Q.dy&&(f=Q.dy),0):Q.dy}).attr('width',J.nodeWidth()).style('fill',function(Q){return-1<F.domain().indexOf(Q.name)?Q.color=F(Q.name):Q.color='#ccc'}),f&&setTimeout(function(){$(k).empty(),g.height=parseFloat(g.height)+parseFloat(Math.abs(f)),new sankey_chart(g)},1e3),P.append('text').style('text-transform','uppercase').attr('x',sankConst.titleX).attr('y',function(Q){return Q.dy/2}).attr('dy',sankConst.titleDY).attr('text-anchor','end').attr('transform',null).text(function(Q){return Q.name}).filter(function(Q){return Q.x<C/2}).attr('x',6+J.nodeWidth()).attr('text-anchor','start'),O.style('stroke',function(Q,R){var S='gradient'+R,T=Q.source.color,U=Q.target.color,V=L.append('linearGradient').attr('id',S);return V.selectAll('stop').data([{offset:'10%',color:T},{offset:'90%',color:U}]).enter().append('stop').attr('offset',function(W){return W.offset}).attr('stop-color',function(W){return W.color}),'url(#'+S+')'})})(c.data),$('body').on('click','.bstheme_menu_button_'+l,function(){var M=$(this).attr('data-target');'none'==$(M).css('display')?$(M).css('display','inline-block'):$(M).css('display','none')}),$('body').on('click','.header_refresh_'+l,function(){var M=$(this).parent().parent().parent().parent().siblings('div').attr('id');'#'+M==t&&($(k).empty(),new sankey_chart(g))}),$('body').on('click','.header_table_'+l,function(){parseInt(o/55);$(t).empty(),$(t).css('overflow','auto'),$(this).css('display','none'),$('.header_chart_'+l).css('display','inline-block');var N=c.data,O='<div id =\'sankey_table_'+l+'\' style=\'padding:5px;background-color: #425661;overflow:hidden;height:'+c.height+'px\'><table id =\'sankey_table1_'+l+'\'class=\' table-striped table-condensed\' style=\'width:100%;background-color:#283C45;padding:5px;color:#5A676E; \' ><thead><tr><th>TYPE</th><th>VALUE</th></tr></thead><tbody>';$.each(N.nodes,function(V,W){O=O+'<tr><td>'+W.name.toUpperCase()+'</td><td>'+W.value+'</td></tr>'}),O+='</tbody></table></div>',$(t).append(O),$('#sankey_table1_'+l).DataTable({bLengthChange:!1,paging:!1,fnRowCallback:function fnRowCallback(V,W,X){1==X%2?$('td',V).css('background-color','#32464F'):$('td',V).css('background-color','#283C45')}}),$('#sankey_table_'+l).mCustomScrollbar({axis:'y'}),$('#sankey_table_'+l+' tr:first').css('background-color','#0CB29A');var P=$('#sankey_table_'+l).children('div').find('div').eq(0),Q=$('#sankey_table_'+l).children('div').find('div').eq(1),R=$('#sankey_table_'+l).children('div').find('div').eq(2),S=P.attr('id'),T=Q.attr('id'),U=R.attr('id');$('#'+S+' label').css('color','#666666'),$('#'+T+' label').css('color','#666666'),$('#'+U).css('color','#666666'),$(' .dataTables_filter input').css({'margin-left':'0.5em',position:'relative',border:'0','min-width':'240px',background:'transparent','border-bottom':'1px solid #666666',' border-radius':' 0',padding:' 5px 25px',color:'#ccc',height:' 30px','-webkit-box-shadow':' none','box-shadow':' none'}),$('.dataTables_wrapper').css('background-color','#374C59')}),$('body').on('click','.header_chart_'+l,function(){$(t).css('overflow','hidden');var M=$(this).parent().parent().parent().parent().siblings('div').attr('id');'#'+M==t&&($(this).css('display','none'),$('.header_table_'+l).css('display','inline-block'),$(k).empty(),new sankey_chart(g))}),$('body').on('click','.header_fullscreen_chart'+l,function(){$('#modal_'+l).modal('show');var M=jQuery.extend(!0,{},g);setTimeout(function(){$('#modal_chart_container'+l).css('width','100%'),M.container='#modal_chart_container'+l,M.headerOptions=!1,M.height=450,new sankey_chart(M)},500)})}